# 実装計画

## タスク概要

本計画は、カタログソースのプリセット選択機能を実装するための段階的なタスクリストです。各タスクは自然言語で「何を実現するか」を記述し、実装の詳細は `design.md` を参照します。

---

## フェーズ 1: バックエンドの基盤整備

- [ ] 1. カタログソースの型定義とバリデーション機能を実装する
- [ ] 1.1 カタログソース識別子の列挙型を定義する
  - Docker と Official の2つのソースを識別可能にする
  - 文字列として扱える列挙型として定義する
  - バックエンドとフロントエンドで一貫した識別子を使用できるようにする
  - _Requirements: 2.1, 2.5, 5.1_

- [ ] 1.2 構造化エラーコードと例外クラスを定義する
  - 無効なソース、レート制限、上流障害、内部エラーの各種エラーコードを定義する
  - エラーコード、メッセージ、再試行秒数を保持する例外クラスを作成する
  - エラーレスポンスのスキーマを定義する
  - _Requirements: 4.1, 4.2_

- [ ] 2. 環境設定にOfficial MCP Registry URLを追加する
- [ ] 2.1 設定クラスにOfficial Registry用のURL設定を追加する
  - Official MCP Registry のデフォルト URL を定義する
  - 環境変数による上書きをサポートする
  - 既存の Docker カタログ URL 設定を維持する（後方互換性）
  - _Requirements: 6.3_

- [ ] 3. URL許可リスト検証機能を実装する
- [ ] 3.1 許可されたURL以外へのアクセスを防止する検証器を作成する
  - 設定で定義されたカタログURL一覧を許可リストとして保持する
  - フェッチ前にURLが許可リスト内にあるか検証する機能を提供する
  - 許可リスト外のURLに対して構造化エラーを返す
  - _Requirements: 5.1, 5.2_

---

## フェーズ 2: バックエンドAPIの拡張

- [ ] 4. カタログAPI エンドポイントを拡張する
- [ ] 4.1 sourceパラメータを受け付けてソースIDを解決する機能を追加する
  - source クエリパラメータを列挙型でバリデーションする
  - パラメータ省略時はDockerをデフォルトとして扱う
  - ソースIDから対応するURLへ解決するロジックを実装する
  - 未知のソースIDに対して構造化エラーレスポンスを返す
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 5.2_

- [ ] 4.2 構造化エラーレスポンスをHTTPレスポンスとして返却する
  - エラーコードに応じた適切なHTTPステータスコードを設定する（400/429/503/500）
  - 内部URL や認証情報をエラーメッセージに含めない
  - レート制限時は retry_after_seconds を含める
  - _Requirements: 4.1, 4.2, 5.4_

- [ ] 5. カタログサービスのエラーハンドリングを強化する
- [ ] 5.1 フェッチ前に許可リスト検証を実行する
  - URL検証器を呼び出してSSRFを防止する
  - 検証失敗時は構造化エラーをスローする
  - _Requirements: 5.1, 5.2_

- [ ] 5.2 上流レジストリのレート制限とタイムアウトに対応する
  - 上流が429を返した場合、Retry-Afterを抽出してレート制限エラーを返す
  - タイムアウトや5xxエラー時は上流障害エラーを返す
  - エラー情報を構造化してAPI層へ伝播する
  - _Requirements: 4.1, 4.2_

- [ ] 5.3 Official MCP Registry形式のJSONパースと変換を実装する
  - Official Registry から返されるスキーマを既存のCatalogItemモデルへマッピングする
  - マッピング不可能な項目は除外する
  - 未知のフィールドは無視する
  - 各アイテムに安定した識別子と表示名を保証する
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 6. 検索APIエンドポイントのsourceパラメータ対応を追加する
- [ ] 6.1 検索機能でもソース選択を可能にする
  - `/api/catalog/search` に source パラメータを追加する
  - `/api/catalog` と同様のソース解決とバリデーションを適用する
  - _Requirements: 2.1, 2.2, 2.5_

---

## フェーズ 3: フロントエンドUI の実装

- [ ] 7. カタログソース選択UIコンポーネントを作成する
- [ ] 7.1 ソース選択セレクタコンポーネントを実装する
  - Docker と Official の2つのプリセットを選択可能なセレクタを作成する
  - フリーフォームのURL入力は提供しない
  - 選択変更時に親コンポーネントへコールバックを通知する
  - Tailwind CSSで既存UIと一貫したスタイリングを適用する
  - _Requirements: 1.1, 5.3_

- [ ] 8. カタログページでソース切替を管理する
- [ ] 8.1 ソース状態管理とリスト再取得の連携を実装する
  - デフォルトで Docker ソースを選択状態にする
  - ユーザーがソースを変更したらカタログリストを再取得する
  - ページリロードなしでソース切替を可能にする
  - エラー発生時も選択中のソースを保持する
  - _Requirements: 1.2, 1.3, 4.5, 6.2, 6.5_

- [ ] 9. カタログ一覧表示のエラーハンドリングを拡張する
- [ ] 9.1 構造化エラーコードに基づくエラー表示を実装する
  - error_code に応じて適切なエラーメッセージを表示する
  - レート制限時は retry_after_seconds のカウントダウンを表示する
  - 上流障害時は再試行ボタンを提供する
  - 取得中はローディング状態を表示する
  - _Requirements: 1.4, 1.5, 4.3, 4.4_

- [ ] 10. カタログAPI クライアントを拡張する
- [ ] 10.1 sourceパラメータをサポートする
  - カタログ取得関数に source パラメータを追加する
  - エラーレスポンスの型定義を追加する
  - 構造化エラーレスポンスをパースして型安全に扱う
  - _Requirements: 2.1_

---

## フェーズ 4: テストと検証

- [ ] 11. バックエンドの単体テストを実装する
- [ ] 11.1 ソース識別子と列挙型のバリデーションをテストする
  - 有効な値（docker、official）が受理されることを確認する
  - 無効な値が拒否されることを確認する
  - _Requirements: 2.1, 2.5_

- [ ] 11.2 ソースID解決ロジックをテストする
  - docker → Docker URL へのマッピングを確認する
  - official → Official URL へのマッピングを確認する
  - _Requirements: 2.3, 2.4_

- [ ] 11.3 URL許可リスト検証をテストする
  - 許可リスト内のURLが通過することを確認する
  - 許可リスト外のURLが拒否されることを確認する
  - _Requirements: 5.1, 5.2_

- [ ] 11.4 構造化エラー生成をテストする
  - 各エラーコードが正しく生成されることを確認する
  - retry_after_seconds が適切に設定されることを確認する
  - _Requirements: 4.1, 4.2_

- [ ] 11.5 Official Registry形式の変換ロジックをテストする
  - 正常なデータが正しく変換されることを確認する
  - マッピング不可能な項目が除外されることを確認する
  - 未知のフィールドが無視されることを確認する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 12. バックエンドの統合テストを実装する
- [ ] 12.1 source=dockerでのエンドツーエンド動作をテストする
  - APIがDockerカタログを正しく返すことを確認する
  - キャッシュ動作を確認する
  - _Requirements: 2.3, 6.1_

- [ ] 12.2 source=officialでのエンドツーエンド動作をテストする
  - APIがOfficial Registryカタログを正しく返すことを確認する
  - スキーマ変換が正常に機能することを確認する
  - _Requirements: 2.4, 3.1_

- [ ] 12.3 sourceパラメータ省略時のデフォルト動作をテストする
  - source未指定時にDockerカタログが返されることを確認する
  - 既存クライアント互換性を確認する
  - _Requirements: 2.2, 6.1, 6.2_

- [ ] 12.4 不正なsource値でのエラーレスポンスをテストする
  - 400 Bad Requestが返されることを確認する
  - error_code: invalid_source が含まれることを確認する
  - 上流へのリクエストが発生しないことを確認する
  - _Requirements: 2.5, 5.2_

- [ ] 12.5 上流レート制限時の動作をテストする
  - 上流が429を返した場合、APIが429を返すことを確認する
  - error_code: rate_limited と retry_after_seconds が含まれることを確認する
  - _Requirements: 4.1_

- [ ] 12.6 上流タイムアウト時の動作をテストする
  - 上流がタイムアウトした場合、503 Service Unavailableが返されることを確認する
  - error_code: upstream_unavailable が含まれることを確認する
  - _Requirements: 4.2_

- [ ] 13. フロントエンドの単体テストを実装する
- [ ] 13.1 ソース選択セレクタのレンダリングをテストする
  - DockerとOfficialの選択肢が表示されることを確認する
  - 選択変更時にコールバックが呼ばれることを確認する
  - _Requirements: 1.1_

- [ ] 13.2 カタログページのソース状態管理をテストする
  - 初期状態でDockerが選択されていることを確認する
  - ソース変更時にカタログ再取得が発生することを確認する
  - エラー時も選択ソースが保持されることを確認する
  - _Requirements: 1.2, 1.3, 4.5_

- [ ] 13.3 エラー表示ロジックをテストする
  - 各error_codeに対応するメッセージが表示されることを確認する
  - レート制限時にカウントダウンが表示されることを確認する
  - 再試行ボタンが適切に表示されることを確認する
  - _Requirements: 1.5, 4.3, 4.4_

- [ ] 14. E2E/UIテストを実装する
- [ ] 14.1 Dockerソース選択時のカタログ表示をテストする
  - セレクタでDockerを選択した際にカタログが表示されることを確認する
  - ローディング状態が正常に動作することを確認する
  - _Requirements: 1.1, 1.2, 1.4_

- [ ] 14.2 Officialソース選択時のカタログ表示をテストする
  - セレクタでOfficialを選択した際にカタログが表示されることを確認する
  - ソース切替でページリロードが発生しないことを確認する
  - _Requirements: 1.1, 1.2, 6.5_

- [ ] 14.3 レート制限エラーのUI動作をテストする
  - レート制限エラー時にカウントダウンが表示されることを確認する
  - カウントダウン後に再試行が可能になることを確認する
  - _Requirements: 4.3_

- [ ] 14.4 上流障害エラーのUI動作をテストする
  - 上流障害時に再試行ボタンが表示されることを確認する
  - 再試行ボタンでカタログ再取得が行われることを確認する
  - _Requirements: 4.4_

---

## フェーズ 5: ドキュメント更新と統合

- [ ] 15. ドキュメントを更新する
- [ ] 15.1 環境変数のドキュメントを更新する
  - CATALOG_OFFICIAL_URL の追加を記載する
  - CATALOG_DEFAULT_URL の非推奨化を明記する
  - 移行ガイドを追加する
  - _Requirements: 6.3_

- [ ] 15.2 APIドキュメントを更新する
  - sourceパラメータの仕様を追加する
  - エラーレスポンスの構造を記載する
  - 使用例を追加する
  - _Requirements: 2.1, 4.1, 4.2_

- [ ] 16. 既存機能との統合を確認する
- [ ] 16.1 既存のカタログ機能が正常に動作することを確認する
  - 既存ユーザーの環境変数設定が尊重されることを確認する
  - NEXT_PUBLIC_CATALOG_URL の影響がないことを確認する
  - Official Registry 不可時でもDockerソースが利用可能であることを確認する
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

---

## 完了基準

すべてのタスクが完了し、以下が満たされた時点で本機能は完成とする：

1. ✅ バックエンドが source パラメータを受け付け、Docker/Official の両ソースから正しくカタログを取得できる
2. ✅ フロントエンドがセレクタUIでソースを選択でき、ページリロードなしで切り替えられる
3. ✅ エラー時に適切なメッセージと再試行手段がユーザーに提示される
4. ✅ 全てのテスト（単体/統合/E2E）がパスする
5. ✅ ドキュメントが更新され、環境変数の移行ガイドが整備される
6. ✅ 既存ユーザーの動作が後方互換性を保ち、破壊的変更がない
