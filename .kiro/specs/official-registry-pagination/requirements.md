# Official MCP Registry ページネーション対応

## 概要

Official MCP Registry (`registry.modelcontextprotocol.io/v0/servers`) はカーソルベースのページネーションを採用しており、1リクエストあたり最大30件のサーバーを返却する。現在の実装では最初の30件のみを取得・表示しているため、レジストリに登録されている全サーバーを閲覧できない。

本仕様では、`metadata.nextCursor` を使用した追跡取得を実装し、Official MCP Registry の全エントリを取得・表示可能にする。

## 背景

### 現状の問題

1. Official MCP Registry API は `metadata.nextCursor` と `metadata.count` を含むレスポンスを返す
2. 現在の `CatalogService._fetch_from_url` は単一リクエストのみ発行し、`nextCursor` を無視している
3. ユーザーは Official ソース選択時に最初の30件しか閲覧できない

### API レスポンス形式

```json
{
  "servers": [
    { "server": { "name": "...", ... }, "_meta": { ... } },
    ...
  ],
  "metadata": {
    "nextCursor": "ai.mcpcap/mcpcap:0.6.0",
    "count": 30
  }
}
```

- `metadata.nextCursor`: 次ページ取得用のカーソル文字列（最終ページでは省略または null）
- `metadata.count`: 現在のレスポンスに含まれるサーバー数

---

## 要件

### Requirement 1: カーソルベースのページネーション取得

- **1.1** バックエンドは Official MCP Registry からのレスポンスに `metadata.nextCursor` が含まれる場合、そのカーソルを使用して次ページを取得する
- **1.2** カーソルが存在しなくなるまで（または設定された上限に達するまで）ページ取得を繰り返す
- **1.3** 取得した全ページのサーバーを結合して単一のカタログリストとして返却する
- **1.4** 各ページ取得間に適切な遅延を設け、上流サービスへの負荷を軽減する

### Requirement 2: 取得制限とタイムアウト

- **2.1** 無限ループ防止のため、最大取得ページ数の上限を設定可能にする（デフォルト: 20ページ = 最大600件）
- **2.2** 全ページ取得の合計タイムアウトを設定可能にする（デフォルト: 60秒）
- **2.3** 上限到達時は取得済みデータを返却し、警告メッセージを付与する
- **2.4** 環境変数による上限値のカスタマイズをサポートする

### Requirement 3: エラーハンドリング

- **3.1** 途中ページでエラーが発生した場合、取得済みデータを返却する（部分成功）
- **3.2** 部分成功時は警告メッセージでユーザーに通知する
- **3.3** レート制限（429）発生時は既存のエラーハンドリングを適用する
- **3.4** 各ページ取得でリトライロジックを適用する

### Requirement 4: キャッシュ統合

- **4.1** 全ページ取得完了後の結合データをキャッシュする
- **4.2** キャッシュヒット時はページネーション取得をスキップする
- **4.3** キャッシュ TTL は既存の設定（`catalog_cache_ttl_seconds`）を適用する

### Requirement 5: パフォーマンスと UX

- **5.1** 初回取得時のローディング表示を維持する
- **5.2** 取得進捗をログに出力する（デバッグ用）
- **5.3** フロントエンドは既存の無限スクロール UI をそのまま利用可能にする（バックエンド側で全件取得済み）

### Requirement 6: 設定

- **6.1** `CATALOG_OFFICIAL_MAX_PAGES`: 最大取得ページ数（デフォルト: 20）
- **6.2** `CATALOG_OFFICIAL_FETCH_TIMEOUT`: 全ページ取得タイムアウト秒数（デフォルト: 60）
- **6.3** `CATALOG_OFFICIAL_PAGE_DELAY`: ページ間遅延ミリ秒（デフォルト: 100）

---

## 非ゴール

- フロントエンドでの段階的ページ取得（バックエンドで一括取得し、フロントエンドは既存の無限スクロールを利用）
- Docker カタログソースへのページネーション適用（GitHub API は異なるページネーション形式のため別対応）
- リアルタイム進捗表示（WebSocket/SSE による取得進捗のストリーミング）

---

## 受け入れ基準

1. Official ソース選択時に30件を超えるサーバーが表示される
2. 全ページ取得完了までローディング状態が維持される
3. 部分成功時に警告メッセージが表示される
4. 既存のキャッシュ機構と統合されている
5. 単体テスト・統合テストがパスする
