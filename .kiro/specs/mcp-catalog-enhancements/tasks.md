# Implementation Plan

- [ ] 1. OAuth 認可フロー基盤を整備する
  - state と PKCE を生成し、認可 URL をカタログ要求スコープ付きで返す
  - コールバックで state 不一致を 401 で遮断し、再認可ガイダンスを返す
  - プロバイダ 4xx は再認可案内付き 400、5xx/タイムアウトは指数バックオフ 3 回の後 502 を返す
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 1.1 トークン保存とローテーションを実装する
  - アクセス/リフレッシュトークンを Bitwarden/暗号化ストレージへ保存し `credential_key` を発行する
  - 有効期限が 15 分未満で自動リフレッシュし、旧トークンを破棄する
  - invalid_grant 失敗時は削除と再認可要求、5xx/タイムアウトはバックオフ 2 回で 503 を返す
  - _Requirements: 1.5, 1.6, 1.7, 1.8_

- [ ] 1.2 スコープポリシーと監査ログを整備する
  - 許可スコープ検証で未許可の場合 400 を返し既存トークンを維持する
  - 管理者によるスコープ変更で保存済みトークンを無効化し再認可を必須化する
  - 非管理者のスコープ変更は 403 とし、監査ログに相関 ID 付きで残す
  - _Requirements: 1.9, 1.10, 1.11_

- [ ] 2. カタログ探索とセッション作成を拡張する
  - カタログ検索で名前・説明・必要シークレットを返す検索 API を整備する
  - サーバー追加要求でセッション専用ゲートウェイコンテナを cgroup/名前空間分離で起動する
  - セッション終了/アイドル 30 分で停止し、異常終了は 1 回再起動する
  - _Requirements: 2.1, 2.2, 2.5_

- [ ] 2.1 セッション設定保存と実行管理を行う
  - 設定変更をセッションストアに保存し即時反映する
  - mcp-exec 同期/非同期で max_run_seconds と output_bytes_limit を適用し、タイムアウト時は部分出力と exit_code=124 を返す
  - 非同期ジョブはステータス取得とログ/ストリーム取得を提供し、完了時に同期と同等の情報を返す
  - _Requirements: 2.3, 2.4_

- [ ] 3. イメージ署名検証を実装する
  - verify_signatures 有効時に署名未検証イメージを拒否し、permit_unsigned/許可リストのみ例外とする
  - enforcement/audit-only モードをグレース期間付きで切替え、失敗時は 422/exit78 または警告付き継続を返す
  - RSA-PSS(SHA-256)/ECDSA(SHA-256) のみ許可し、JWKS/ローカルトラストストアを 6h キャッシュし OCSP/CRL 検証する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 4. 外部/E2B ゲートウェイ接続とヘルスチェックを実装する
  - URL スキーマ検証と許可リスト突き合わせ（グローバル優先＋組織上書き）で未登録を 400 とする
  - 保存直後/手動/5 分間隔で `/healthcheck` を実行し、1→2→4s バックオフと timeout 10〜30s を適用する
  - p50/p95/p99 と最終エラーをレスポンスとメトリクスに記録し、成功時に外部モードを有効化、失敗時は無効を維持する
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 5. フロントエンド UI を拡張する
  - OAuth モーダルで認可開始/コールバック結果/再認可を扱い、state/PKCE をクライアント側で保持する
  - Catalog UI に必要スコープ・署名検証フラグ・必須シークレット表示と検索/カテゴリフィルタを追加する
  - Session/Execution パネルでゲートウェイ状態、mcp-exec 実行、ログ/ステータスストリーム、タイムアウト/トランケーション表示を行う
  - 署名検証無効化時のリスク警告ダイアログと allowlist 判定結果表示を行う
  - _Requirements: 1.*, 2.*, 3.3, 3.4, 4.3, 4.4_

- [ ] 6. セキュリティ・監査・メトリクスを強化する
  - 相関 ID 付き監査ログで OAuth/署名検証/allowlist 判定を記録し、秘密情報を除外する
  - ゲートウェイ/署名検証/ヘルスチェックのメトリクスを収集し、モード切替や失敗カテゴリを分類する
  - mTLS 証明書をセッション起動時に生成・マウントし、終了時に破棄する
  - _Requirements: 1.*, 2.2, 3.*, 4.2, 4.4_

- [ ] 7. テストを実装する
  - ユニット: state/PKCE 生成、トークン保存/ローテーション、署名検証モード分岐、allowlist 判定、SessionConfig バリデーション
  - 統合: OAuth 成功/失敗パス、署名検証 enforcement/audit-only、セッション起動と mcp-exec 同期/非同期、ヘルスチェックリトライ
  - E2E/UI: 認可フロー完走、署名検証無効化警告、ゲートウェイ起動/停止、ログストリーム、接続テストステータス表示
  - _Requirements: 1.*, 2.*, 3.*, 4.*_

