# Implementation Plan

## 概要

本タスクプランは、Docker MCP Gateway Web Console の大規模リファクタリングを段階的に実装するための実装タスクを定義します。Redis によるステートレス化、ARQ Worker による非同期処理、セキュリティ強化（ログサニタイズ・SSRF 対策・暗号化キー管理）、DevContainer 統合を順次実装します。

---

## Phase 1: Infrastructure Setup

- [ ] 1. Redis 統合の基盤を構築する
- [ ] 1.1 Redis サービスクラスを実装する
  - Redis への非同期接続管理機能を提供する
  - セッションデータの CRUD 操作インターフェースを実装する
  - キャッシュ操作（set/get/delete）を提供する
  - ヘルスチェック機能を実装する
  - 接続エラー時の例外ハンドリングを実装する
  - _Requirements: 1.1, 1.3, 3.1, 3.2_

- [ ] 1.2 Docker Compose に Redis コンテナを追加する
  - Redis 7-alpine イメージを使用したサービス定義を追加する
  - 永続化ボリュームを設定する
  - ヘルスチェックを設定する
  - ネットワーク設定を既存サービスと統合する
  - _Requirements: 1.1_

- [ ] 1.3 Redis 接続のライフサイクル管理を実装する
  - FastAPI lifespan イベントで Redis 接続を初期化する
  - アプリケーション終了時に Redis 接続をクリーンアップする
  - 接続失敗時のエラーハンドリングを実装する
  - Redis ヘルスチェックエンドポイントを追加する
  - _Requirements: 1.4_

- [ ] 2. 暗号化キー管理を厳格化する
- [ ] 2.1 KeyManager サービスを実装する
  - 暗号化キーの検証ロジックを実装する
  - 環境変数から暗号化キーを安全に読み込む機能を提供する
  - Fernet インスタンス生成機能を実装する
  - キーフォーマット検証機能を実装する
  - _Requirements: 5.1, 5.3_

- [ ] 2.2 Fail Fast 起動制御を実装する
  - FastAPI lifespan イベントで暗号化キーを検証する
  - 全環境で必須キーが未設定の場合に起動を中止する
  - キー検証失敗時のエラーメッセージを明確化する
  - 既存の自動生成・ファイル保存ロジックを削除する
  - _Requirements: 5.2, 5.4_

- [ ] 2.3 環境変数設定例を更新する
  - `.env.example` に必須暗号化キーを追加する
  - キー生成手順をドキュメント化する
  - 開発環境用のサンプルキーを提供する
  - Production プロファイルでの必須要件を明記する
  - _Requirements: 5.2_

- [ ] 3. ログサニタイズ機構を実装する
- [ ] 3.1 ログフィルタを実装する
  - 機密情報パターンマッチングロジックを実装する
  - マスク処理機能を実装する
  - サニタイズ失敗時のフォールバック処理を実装する
  - 機密エンドポイント判定ロジックを実装する
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 3.2 ログ設定にサニタイズフィルタを適用する
  - アプリケーションログハンドラにフィルタを登録する
  - uvicorn ログハンドラにフィルタを統合する
  - フィルタ適用順序を最適化する
  - ログ出力テストを実装する
  - _Requirements: 4.1, 4.2_

- [ ] 3.3 エラーレスポンスのサニタイズを実装する
  - 例外ハンドラで機密情報を除外する
  - エラーメッセージから秘密値を削除する
  - スタックトレースのサニタイズを実装する
  - 安全なエラーレスポンスフォーマットを定義する
  - _Requirements: 4.4_

---

## Phase 2: Session Migration to Redis

- [ ] 4. 認証セッション管理を Redis に移行する
- [ ] 4.1 Redis ベースの認証セッションストアを実装する
  - 認証セッションの保存機能を実装する
  - 認証セッションの取得機能を実装する
  - 認証セッションの削除機能を実装する
  - セッション TTL 延長機能を実装する
  - _Requirements: 1.1, 1.2_

- [ ] 4.2 AuthService を Redis ストアに切り替える
  - 既存の StateStore 呼び出しを RedisService に置き換える
  - セッション生成ロジックを更新する
  - ログイン/ログアウトフローを Redis に対応させる
  - 既存 API コントラクトを維持する
  - _Requirements: 1.2, 9.1_

- [ ] 4.3 セッション検証ミドルウェアを更新する
  - Redis からセッション情報を取得するよう変更する
  - セッションタイムアウト判定を実装する
  - 最終アクティビティ更新ロジックを実装する
  - Redis 接続エラー時のエラーハンドリングを実装する
  - _Requirements: 1.2, 1.4_

- [ ] 4.4 複数インスタンス対応のセッション管理を実装する
  - Redis 経由でのセッション状態共有を検証する
  - 並行アクセス時の一貫性を保証する
  - セッション更新の競合制御を実装する
  - 分散環境でのテストケースを追加する
  - _Requirements: 1.3_

- [ ] 5. ゲートウェイセッション管理を Redis に移行する
- [ ] 5.1 Redis ベースのゲートウェイセッションストアを実装する
  - ゲートウェイセッションの保存機能を実装する
  - ゲートウェイセッションの取得機能を実装する
  - ゲートウェイセッションの削除機能を実装する
  - idle_deadline ベースの TTL 管理を実装する
  - _Requirements: 1.1, 1.2_

- [ ] 5.2 mTLS 証明書の共有ボリューム保存を実装する
  - 証明書ファイルの生成と保存機能を実装する
  - ファイル権限（0600）の設定を実装する
  - セッション ID ベースのディレクトリ構造を構築する
  - 証明書パス参照をセッションレコードに保持する
  - _Requirements: 1.1_

- [ ] 5.3 SessionService を Redis ストアに切り替える
  - 既存の StateStore 呼び出しを RedisService に置き換える
  - セッション起動・停止ロジックを更新する
  - mTLS バンドル生成フローを共有ボリュームに対応させる
  - 既存 API コントラクトを維持する
  - _Requirements: 1.2, 9.1_

- [ ] 5.4 セッションクリーンアップロジックを実装する
  - 期限切れセッションの検出機能を実装する
  - Redis からの期限切れセッション削除を実装する
  - mTLS 証明書ファイルのクリーンアップを実装する
  - クリーンアップエラー時のログ記録を実装する
  - _Requirements: 3.3_

---

## Phase 3: Async Job Queue with ARQ

- [ ] 6. ARQ Worker 基盤を構築する
- [ ] 6.1 ARQ Worker 設定を実装する
  - Worker 設定クラスを定義する
  - Redis 接続設定を構成する
  - ジョブタイムアウト設定を定義する
  - 最大並行ジョブ数を設定する
  - _Requirements: 2.1_

- [ ] 6.2 Worker コンテナを Docker Compose に追加する
  - Worker サービス定義を追加する
  - Backend と同じイメージを使用する設定を構成する
  - Bitwarden CLI と Docker ソケットをマウントする
  - Redis への依存関係を設定する
  - _Requirements: 2.2_

- [ ] 6.3 Worker ライフサイクル管理を実装する
  - Worker 起動スクリプトを作成する
  - Worker ヘルスチェック機能を実装する
  - Worker シャットダウン処理を実装する
  - Worker エラーハンドリングを実装する
  - _Requirements: 2.2_

- [ ] 7. JobQueue サービスを実装する
- [ ] 7.1 ジョブエンキュー機能を実装する
  - ARQ Redis プールの初期化を実装する
  - ジョブのエンキュー API を実装する
  - ジョブ ID 生成機能を実装する
  - ジョブメタデータの保存機能を実装する
  - _Requirements: 2.1_

- [ ] 7.2 ジョブ状態管理機能を実装する
  - ジョブステータスの取得機能を実装する
  - ジョブ結果の保存・取得機能を実装する
  - ジョブエラー情報の管理機能を実装する
  - ジョブタイムスタンプの記録機能を実装する
  - _Requirements: 2.3_

- [ ] 7.3 ジョブ制御機能を実装する
  - ジョブキャンセル機能を実装する
  - ジョブリトライロジックを実装する
  - ジョブタイムアウト処理を実装する
  - ジョブクリーンアップ機能を実装する
  - _Requirements: 2.3_

- [ ] 8. Bitwarden 処理の非同期化を実装する
- [ ] 8.1 Bitwarden 解決 Worker 関数を実装する
  - Bitwarden CLI 実行ロジックを Worker に移植する
  - シークレット解決処理を実装する
  - エラーハンドリングとログ記録を実装する
  - 機密情報を含まない失敗レスポンスを生成する
  - _Requirements: 2.2, 2.4_

- [ ] 8.2 非同期 API エンドポイントを実装する
  - `async=true` パラメータの処理を追加する
  - 同期モード（既定）と非同期モードの分岐を実装する
  - HTTP 202 + job_id レスポンスを返す機能を実装する
  - 後方互換性を維持する
  - _Requirements: 2.1, 9.1_

- [ ] 8.3 ジョブ状態取得エンドポイントを実装する
  - `GET /api/jobs/{job_id}` エンドポイントを作成する
  - セッション検証とジョブ所有権確認を実装する
  - ジョブステータスとレスポンスを返す機能を実装する
  - 権限エラー時の 404 レスポンスを実装する
  - _Requirements: 2.3_

- [ ] 8.4 コンテナ操作の非同期対応を実装する
  - コンテナインストール処理を非同期化する
  - Bitwarden 参照解決を非同期ジョブに委譲する
  - ジョブ完了後のコンテナ起動フローを実装する
  - エラー発生時のロールバック処理を実装する
  - _Requirements: 2.1, 2.2_

- [ ] 9. SecretManager のキャッシュを Redis に移行する
- [ ] 9.1 Redis ベースのシークレットキャッシュを実装する
  - キャッシュキー生成ロジックを実装する
  - 暗号化されたシークレットの保存機能を実装する
  - 暗号化されたシークレットの取得機能を実装する
  - キャッシュ TTL 管理を実装する
  - _Requirements: 3.1, 3.4_

- [ ] 9.2 SecretManager をキャッシュバックエンドに対応させる
  - 既存のインメモリキャッシュを Redis に置き換える
  - キャッシュミス時の Bitwarden 取得ロジックを維持する
  - セッションスコープのキャッシュ隔離を実装する
  - キャッシュヒット/ミスのログ記録を実装する
  - _Requirements: 3.2_

- [ ] 9.3 セッション終了時のキャッシュクリーンアップを実装する
  - ログアウト時のキャッシュ削除を実装する
  - セッションタイムアウト時のキャッシュ削除を実装する
  - プレフィックスベースの一括削除を実装する
  - クリーンアップ失敗時のログ記録を実装する
  - _Requirements: 3.3_

- [ ] 9.4 平文永続化の排除を検証する
  - SQLite に秘密値が保存されないことを確認する
  - Redis キャッシュの暗号化を検証する
  - mTLS 証明書の適切な権限設定を検証する
  - メモリダンプ時の秘密情報漏えいリスクを評価する
  - _Requirements: 3.4_

---

## Phase 4: Security Hardening

- [ ] 10. SSRF 対策を実装する
- [ ] 10.1 URL バリデータサービスを実装する
  - URL スキーム検証ロジックを実装する
  - DNS 解決と IP アドレス検証を実装する
  - プライベート IP・ループバック・リンクローカルのブロック処理を実装する
  - メタデータエンドポイントのブロック処理を実装する
  - _Requirements: 6.1, 6.2_

- [ ] 10.2 IPv6 正規化とマルチレコード検証を実装する
  - IPv6 アドレスの正規化処理を実装する
  - A および AAAA レコード両方の解決を実装する
  - 全解決 IP に対する検証を実装する
  - いずれか一つでもブロック対象なら例外を送出する処理を実装する
  - _Requirements: 6.2_

- [ ] 10.3 TOCTOU 対策の安全な接続機能を実装する
  - DNS 解決・検証・接続を原子的に実行する関数を実装する
  - 検証済み IP での即座接続を実装する
  - ソケット再利用可能な実装を提供する
  - タイムアウト設定を実装する
  - _Requirements: 6.2_

- [ ] 10.4 CatalogService に SSRF 対策を統合する
  - カタログ URL 設定時の検証を実装する
  - HTTP リクエスト前の URL 検証を実装する
  - ブロック時のエラーメッセージと修正手順を提供する
  - 内部ネットワークへのアクセス防止を検証する
  - _Requirements: 6.1, 6.3, 6.4_

- [ ] 11. Config と Secrets の分離を実装する
- [ ] 11.1 Config と Secrets のデータモデルを分離する
  - Config 専用の Pydantic モデルを定義する
  - Secrets 専用の Pydantic モデルを定義する
  - モデル間の境界と責務を明確化する
  - バリデーションルールを各モデルに実装する
  - _Requirements: 7.1_

- [ ] 11.2 Config 永続化経路から Secrets を排除する
  - Config 保存時に Secrets フィールドを除外する
  - Secrets を含む入力の検証を実装する
  - 誤った経路での Secrets 保存を防止する
  - Config 保存処理のテストを実装する
  - _Requirements: 7.2, 7.3_

- [ ] 11.3 Secrets の承認された保管経路を実装する
  - OAuth トークンの暗号化保存経路を維持する
  - Bitwarden セッションキーの Redis 保存を維持する
  - GitHub トークンの暗号化保存を維持する
  - 各保管経路のアクセス制御を実装する
  - _Requirements: 7.3_

- [ ] 11.4 Secrets の DB 永続化排除を検証する
  - SQLite に Secrets が保存されないことをテストする
  - 暗号化された値のみが永続化されることを検証する
  - 開発環境での検証手順をドキュメント化する
  - CI/CD での自動検証を実装する
  - _Requirements: 7.4_

---

## Phase 5: DevContainer Integration

- [ ] 12. DevContainer 環境を構築する
- [ ] 12.1 devcontainer.json を作成する
  - マルチコンテナ構成（Frontend/Backend/Worker/Redis）を定義する
  - VS Code 拡張機能の推奨リストを設定する
  - ポートフォワーディング設定（3000, 8000）を構成する
  - 環境変数の設定を定義する
  - _Requirements: 8.1, 8.2_

- [ ] 12.2 Docker Compose for DevContainer を作成する
  - `.devcontainer/docker-compose.yml` を作成する
  - 既存の `docker-compose.yml` と統合する
  - 開発用の設定を追加する
  - ボリュームマウント設定を最適化する
  - _Requirements: 8.1_

- [ ] 12.3 自動テスト実行環境を構成する
  - DevContainer 内でのテスト実行設定を構成する
  - Unit テスト実行コマンドを定義する
  - Integration テスト実行コマンドを定義する
  - テスト結果の表示設定を構成する
  - _Requirements: 8.3_

- [ ] 12.4 開発者向けドキュメントを作成する
  - DevContainer の起動手順をドキュメント化する
  - テスト実行手順（`docker compose exec` または `devcontainer exec`）を提供する
  - トラブルシューティングガイドを作成する
  - 環境変数設定ガイドを作成する
  - _Requirements: 8.4_

---

## Phase 6: Testing & Validation

- [ ] 13. Unit テストを実装する
- [ ] 13.1 RedisService のテストを実装する
  - 接続管理テストを実装する
  - セッション CRUD テストを実装する
  - キャッシュ操作テストを実装する
  - エラーハンドリングテストを実装する
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 13.2 JobQueue のテストを実装する
  - ジョブエンキューテストを実装する
  - ジョブ状態管理テストを実装する
  - ジョブ制御テストを実装する
  - エラーハンドリングテストを実装する
  - _Requirements: 2.1, 2.3_

- [ ] 13.3 LogSanitizer のテストを実装する
  - パターンマッチングテストを実装する
  - マスク処理テストを実装する
  - フォールバック処理テストを実装する
  - エンドポイント判定テストを実装する
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 13.4 KeyManager のテストを実装する
  - キー検証テストを実装する
  - Fail Fast ロジックテストを実装する
  - Fernet インスタンス生成テストを実装する
  - エラーメッセージテストを実装する
  - _Requirements: 5.1, 5.2_

- [ ] 13.5 UrlValidator のテストを実装する
  - スキーム検証テストを実装する
  - IP アドレス検証テストを実装する
  - IPv6 正規化テストを実装する
  - TOCTOU 対策テストを実装する
  - _Requirements: 6.1, 6.2_

- [ ] 14. Integration テストを実装する
- [ ] 14.1 Redis セッション統合テストを実装する
  - ログイン〜ログアウトフローテストを実装する
  - セッションタイムアウトテストを実装する
  - 複数インスタンス対応テストを実装する
  - Redis 障害時の動作テストを実装する
  - _Requirements: 1.2, 1.3, 1.4_

- [ ] 14.2 ARQ ジョブ実行統合テストを実装する
  - Bitwarden 解決ジョブのエンドツーエンドテストを実装する
  - ジョブタイムアウト動作テストを実装する
  - ジョブキャンセル動作テストを実装する
  - Worker 障害時の動作テストを実装する
  - _Requirements: 2.1, 2.2, 2.3_

- [ ] 14.3 SSRF 対策統合テストを実装する
  - カタログ取得での SSRF ブロックテストを実装する
  - プライベート IP へのアクセスブロックテストを実装する
  - メタデータエンドポイントへのアクセスブロックテストを実装する
  - エラーメッセージの適切性テストを実装する
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 14.4 Config/Secrets 分離統合テストを実装する
  - Config 保存時の Secrets 除外テストを実装する
  - Secrets の承認経路保存テストを実装する
  - DB への Secrets 永続化排除テストを実装する
  - 暗号化保存の検証テストを実装する
  - _Requirements: 7.2, 7.3, 7.4_

- [ ] 15. E2E テストを実装する
- [ ] 15.1 セッションフロー E2E テストを実装する
  - ログイン〜コンテナ起動〜ログアウトの完全フローテストを実装する
  - UI からの操作テストを実装する
  - セッション永続化検証テストを実装する
  - 複数ブラウザでのセッション共有テストを実装する
  - _Requirements: 1.2, 9.3_

- [ ] 15.2 非同期ジョブ E2E テストを実装する
  - 非同期モードでのコンテナインストールテストを実装する
  - ジョブ状態ポーリングテストを実装する
  - ジョブ完了後のコンテナ起動確認テストを実装する
  - ジョブ失敗時のエラー表示テストを実装する
  - _Requirements: 2.1, 2.3, 2.4_

---

## Phase 7: Documentation & Migration

- [ ] 16. ドキュメントを更新する
- [ ] 16.1 アーキテクチャドキュメントを更新する
  - Redis 統合の説明を追加する
  - ARQ Worker の説明を追加する
  - データフロー図を更新する
  - コンポーネント図を更新する
  - _Requirements: All_

- [ ] 16.2 環境変数ドキュメントを更新する
  - 新規環境変数（REDIS_URL, ENVIRONMENT）を追加する
  - 必須環境変数の説明を更新する
  - 環境別の設定例を提供する
  - 暗号化キー生成手順を追加する
  - _Requirements: 5.2, 8.1_

- [ ] 16.3 デプロイドキュメントを更新する
  - Redis セットアップ手順を追加する
  - Worker デプロイ手順を追加する
  - 環境変数設定手順を更新する
  - トラブルシューティングガイドを追加する
  - _Requirements: All_

- [ ] 16.4 API ドキュメントを更新する
  - 新規エンドポイント（/api/jobs/{job_id}）を追加する
  - 非同期モードパラメータの説明を追加する
  - エラーコード一覧を更新する
  - レスポンススキーマを更新する
  - _Requirements: 2.1, 2.3_

- [ ] 17. マイグレーション計画を実行する
- [ ] 17.1 段階的デプロイ戦略を準備する
  - Blue-Green デプロイ手順を定義する
  - ロールバック手順を定義する
  - データ移行スクリプトを作成する
  - 検証チェックリストを作成する
  - _Requirements: 9.1_

- [ ] 17.2 既存 SQLite データの移行を実施する
  - SQLite から Redis へのセッション移行スクリプトを作成する
  - 移行中の動作保証戦略を定義する
  - 移行完了後の SQLite テーブル削除手順を定義する
  - 移行検証手順を定義する
  - _Requirements: 9.1_

- [ ] 17.3 後方互換性検証を実施する
  - 既存フロントエンドとの統合テストを実行する
  - API コントラクト維持を検証する
  - 主要機能の動作検証を実施する
  - パフォーマンステストを実施する
  - _Requirements: 9.1, 9.2, 9.3_

- [ ] 17.4 本番環境デプロイを実施する
  - 本番環境への Redis デプロイを実施する
  - Worker コンテナのデプロイを実施する
  - 暗号化キーの安全な配布を実施する
  - デプロイ後の動作確認を実施する
  - _Requirements: All_
