version: '3.8'

# Docker Compose configuration for E2E testing
# This extends the base docker-compose.yml with test-specific settings

services:
  frontend:
    image: "${E2E_FRONTEND_IMAGE:-docker-mcp-gateway-web-console-frontend:latest}"
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      # Default: dynamic host port (e.g., ":3000"). CI can override with "3001:3000".
      - "${E2E_FRONTEND_PORT_MAPPING:-:3000}"
    command: >
      sh -c "npm run build &&
      if [ -d public ]; then rm -rf .next/standalone/public && cp -r public .next/standalone/; fi &&
      rm -rf .next/standalone/.next/static && mkdir -p .next/standalone/.next && cp -r .next/static .next/standalone/.next/ &&
      node .next/standalone/server.js"
    shm_size: 1gb  # Chromium requires at least 1GB shared memory for E2E tests
    environment:
      - NEXT_PUBLIC_API_URL=
      - INTERNAL_API_URL=http://backend:8000
      - NODE_ENV=production
      - CI=true
      - PORT=3000
      - HOSTNAME=0.0.0.0
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - mcp-gateway-test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 5s
      timeout: 5s
      retries: 6
      start_period: 120s

  backend:
    image: "${E2E_BACKEND_IMAGE:-docker-mcp-gateway-web-console-backend:latest}"
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    working_dir: /app
    ports:
      # Default: dynamic host port (e.g., ":8000"). CI can override with "8001:8000".
      - "${E2E_BACKEND_PORT_MAPPING:-:8000}"
    environment:
      - BITWARDEN_CLI_PATH=/usr/local/bin/bw
      - DOCKER_HOST=${DOCKER_HOST:-unix://${DOCKER_SOCKET_PATH:-/run/user/${UID:-1000}/docker.sock}}
      - PYTHONPATH=/app
      - SESSION_TIMEOUT_MINUTES=30
      - CATALOG_CACHE_TTL_SECONDS=3600
      - CORS_ORIGINS=http://localhost:3001
      - LOG_LEVEL=DEBUG
      - PYTHONUNBUFFERED=1
      - TESTING=true
    networks:
      - mcp-gateway-test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/docs"]
      interval: 5s
      timeout: 5s
      retries: 6
      start_period: 10s

  # Playwright test runner
  playwright:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    shm_size: 1gb  # Chromium requires at least 1GB shared memory for E2E tests
    environment:
      - PLAYWRIGHT_BASE_URL=http://frontend:3000
      - CI=true
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    networks:
      - mcp-gateway-test
    command: npx playwright test
    profiles:
      - test  # Only run when explicitly requested

networks:
  mcp-gateway-test:
    driver: bridge

volumes:
  bw-cli-config:
  bw-cli-cache:
